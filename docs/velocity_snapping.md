# Velocity Snapping

Velocity snapping and snap zones are well established terms in Quake 3 Defrag, see for instance [Jelvan1/q3df-doc](https://github.com/Jelvan1/q3df-doc).
However, there is a subtle but significant change to how this works in Elite Force.

## Code Difference

In Quake 3, velocity snapping happens in a call to `trap_SnapVector` ([Quake-III-Arena/code/game/bg_pmove.c#L2015](https://github.com/id-Software/Quake-III-Arena/blob/dbe4ddb10315479fc00086f08e25d968b4b43c49/code/game/bg_pmove.c#L2015)).
[From there](https://github.com/id-Software/Quake-III-Arena/blob/dbe4ddb10315479fc00086f08e25d968b4b43c49/code/game/g_syscalls.c#L226) it ends up in `Sys_SnapVector` ([Windows](https://github.com/id-Software/Quake-III-Arena/blob/dbe4ddb10315479fc00086f08e25d968b4b43c49/code/win32/win_shared.c#L68), [Linux](https://github.com/id-Software/Quake-III-Arena/blob/dbe4ddb10315479fc00086f08e25d968b4b43c49/code/unix/snapvector.nasm#L41), [Apple](https://github.com/id-Software/Quake-III-Arena/blob/dbe4ddb10315479fc00086f08e25d968b4b43c49/code/unix/unix_shared.c#L151)), which results in all floating-point components of the velocity vector being rounded to the nearest integer.

In Elite Force on the other hand, the snapping happens in a "call" to `SnapVector` ([stvoyef/game/bg_pmove.cpp#L2624](https://github.com/kugelrund/Elite-Reinforce/blob/04e0e618d1ee57a2919f1a852a688c03b1aa155d/game/bg_pmove.cpp#L2624))
which is a macro defined as ([stvoyef/game/q_shared.h#L464](https://github.com/kugelrund/Elite-Reinforce/blob/c505b2ad8e7686274092639b9c2f23b72976b020/game/q_shared.h#L464)):

```cpp
#define SnapVector(v) {v[0]=(int)v[0];v[1]=(int)v[1];v[2]=(int)v[2];}
```

So here the `float` values are just cast to `int`, meaning that they are always rounded towards zero rather than to the nearest integer.
Note that the following implicit conversion back to `float` does not have any relevant effects, as it can be performed losslessly for any reasonable velocity values.

So while in Quake 3 the magnitude of the velocity components is sometimes rounded up and sometimes rounded down, in Elite Force they are always rounded down.
This makes it quite a bit more difficult to build speed in Elite Force, especially when already at high speeds.
This effect becomes even worse at higher framerates (`com_maxfps`), as the player physics are computed more frequently, meaning that the velocity snapping is applied more frequently too.

## Reason for the Difference

According to a changelog in the Quake 3 source release ([Quake-III-Arena/code/unix/ChangeLog#L1432](https://github.com/id-Software/Quake-III-Arena/blob/dbe4ddb10315479fc00086f08e25d968b4b43c49/code/unix/ChangeLog#L1432)), the `trap_SnapVector` function may have been introduced only as late as December of 2000.
The surrounding changelog entries and comments in the corresponding code seem to indicate that float-to-int rounding had been causing quite some trouble and inconsistencies.
In particular it looks like in some early version, the just-in-time compilation of QVM code to x86 would emit code that rounds to the nearest integer ([Quake-III-Arena/code/qcommon/vm_x86.c#L996](https://github.com/id-Software/Quake-III-Arena/blob/dbe4ddb10315479fc00086f08e25d968b4b43c49/code/qcommon/vm_x86.c#L996-L1000)) for `OP_CVFI` which is the intermediate representation of a cast from `float` to `int` generated by LCC.
And so to ensure compatibility with that behaviour, important physics code like the velocity snapping would have had to make sure to use rounding to nearest in all options between native DLL, compiled QVM and interpreted QVM code.

Unfortunately, the history of the actual changes in the Quake 3 code does not seem to be available, so we can only speculate what the early versions might have looked like exactly.
But it does not seem unreasonable to assume that early on Quake 3 had been using the same `SnapVector` macro for the velocity snapping in `bg_pmove.c` that Elite Force uses.
In fact that macro does still exist in the released version of the Quake 3 source code ([`Quake-III-Arena/game/q_shared.h#L646`](https://github.com/id-Software/Quake-III-Arena/blob/dbe4ddb10315479fc00086f08e25d968b4b43c49/code/game/q_shared.h#L646)), but it is only used in other contexts.

So with Elite Force being released in September of 2000, it seems likely that the version of the Quake 3 engine that Raven was working with did not have the `trap_SnapVector` version yet and instead used the simple `SnapVector` macro.
And since the singleplayer of Elite Force does not use the Quake Virtual Machine at all and instead only runs the game modules as native DLLs, this would get it the standard behaviour for casting `float` to `int`, which is rounding towards zero.

## After Elite Force

Starting with the Jedi Outcast singleplayer, Raven got rid of the `SnapVector` call ([jedioutcast/code/game/bg_pmove.cpp](https://github.com/kugelrund/Speed-Outcast/blob/1963e9b17e0b3b897bb44a0bc4901a8cad007ff4/code/game/bg_pmove.cpp#L9038)).
The code comment ([Quake-III-Arena/code/game/bg_pmove.c#L2014](https://github.com/id-Software/Quake-III-Arena/blob/dbe4ddb10315479fc00086f08e25d968b4b43c49/code/game/bg_pmove.c#L2014)) right above the velocity snapping explains that the intent of it in Quake 3 was to save bandwidth, which really did not matter for the singleplayer, so supposedly Raven decided to remove it.
So the singleplayer of both Jedi Outcast and Jedi Academy have no form of velocity snapping or snap zones at all.

Interestingly, for the multiplayer Jedi Outcast does use `trap_SnapVector` ([jedioutcast/CODE-mp/game/bg_pmove.c#L4589](https://github.com/jedis/jedioutcast/blob/1963e9b17e0b3b897bb44a0bc4901a8cad007ff4/CODE-mp/game/bg_pmove.c#L4589)) and what looks like the same implementations of `Sys_SnapVector` and `OP_CVFI` as in the release version of the Quake 3 source code, while the multiplayer for Elite Force still uses the `SnapVector` macro ([STEF-MP-Game-Source/Code-DM/game/bg_pmove.c#L2242](https://github.com/UberGames/STEF-MP-Game-Source/blob/fab9bebea7bfc5f0187bd4a02cd80858926f33d7/Code-DM/game/bg_pmove.c#L2242)), just like the singleplayer.
That supports the theory that the version of the Quake 3 engine that Raven was working with for Elite Force was still using the plain `SnapVector` macro.
And presumably when moving on to Jedi Outcast they updated their multiplayer code with the changes from the latest version of the Quake 3 engine.
